local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local targetImageId = "rbxassetid://2908769190"
local fieldPosition = Vector3.new(-331.6, 68.0, -183.1)

local MOVE_SPEED = 12
local CHECK_INTERVAL = 1
local lastCheckTime = 0

local isActive = false
local needGlitter = true
local dragging = false
local dragStart = Vector2.new(0, 0)
local frameStart = Vector2.new(0, 0)

for _, gui in pairs(player.PlayerGui:GetChildren()) do
    if gui.Name == "AutoBuffGUI" then
        gui:Destroy()
    end
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoBuffGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player.PlayerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 300, 0, 200)
frame.Position = UDim2.new(0.5, -150, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 2
frame.BorderColor3 = Color3.fromRGB(0, 170, 255)
frame.Active = true
frame.Selectable = true
frame.Parent = screenGui

local titleBar = Instance.new("TextButton")
titleBar.Text = ""
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
titleBar.AutoButtonColor = false
titleBar.Parent = frame

local title = Instance.new("TextLabel")
title.Text = "Auto Field Buff"
title.Size = UDim2.new(0.8, 0, 1, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.Parent = titleBar

local closeButton = Instance.new("TextButton")
closeButton.Text = "X"
closeButton.Size = UDim2.new(0, 30, 1, 0)
closeButton.Position = UDim2.new(1, -30, 0, 0)
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.TextColor3 = Color3.new(1, 1, 1)
closeButton.Font = Enum.Font.SourceSansBold
closeButton.TextSize = 16
closeButton.Parent = titleBar

local toggleBtn = Instance.new("TextButton")
toggleBtn.Text = "Enable Auto Buff"
toggleBtn.Size = UDim2.new(0.8, 0, 0, 40)
toggleBtn.Position = UDim2.new(0.1, 0, 0.2, 0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.SourceSansBold
toggleBtn.TextSize = 16
toggleBtn.Parent = frame

local statusLabel = Instance.new("TextLabel")
statusLabel.Text = "Status: Inactive"
statusLabel.Size = UDim2.new(1, 0, 0, 25)
statusLabel.Position = UDim2.new(0, 0, 0.45, 0)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextSize = 14
statusLabel.Parent = frame

local nextItemLabel = Instance.new("TextLabel")
nextItemLabel.Text = "Next: -"
nextItemLabel.Size = UDim2.new(1, 0, 0, 25)
nextItemLabel.Position = UDim2.new(0, 0, 0.6, 0)
nextItemLabel.BackgroundTransparency = 1
nextItemLabel.TextColor3 = Color3.new(0.8, 0.8, 1)
nextItemLabel.Font = Enum.Font.SourceSans
nextItemLabel.TextSize = 14
nextItemLabel.Parent = frame

local barSizeLabel = Instance.new("TextLabel")
barSizeLabel.Text = "Bar size: -"
barSizeLabel.Size = UDim2.new(1, 0, 0, 25)
barSizeLabel.Position = UDim2.new(0, 0, 0.75, 0)
barSizeLabel.BackgroundTransparency = 1
barSizeLabel.TextColor3 = Color3.new(1, 1, 0.8)
barSizeLabel.Font = Enum.Font.SourceSans
barSizeLabel.TextSize = 14
barSizeLabel.Parent = frame

local debugLabel = Instance.new("TextLabel")
debugLabel.Text = "Debug: OK"
debugLabel.Size = UDim2.new(1, 0, 0, 25)
debugLabel.Position = UDim2.new(0, 0, 0.9, 0)
debugLabel.BackgroundTransparency = 1
debugLabel.TextColor3 = Color3.new(0.8, 1, 0.8)
debugLabel.Font = Enum.Font.SourceSans
debugLabel.TextSize = 12
debugLabel.Parent = frame

local function findBuffIconTile()
    local tileGrid = player.PlayerGui.ScreenGui.TileGrid
    
    local child17 = tileGrid:GetChildren()[17]
    if child17 then
        if child17.BG and child17.BG.Icon then
            if child17.BG.Icon.Image == targetImageId then
                return child17
            end
        end
    end
    
    for i, child in ipairs(tileGrid:GetChildren()) do
        if child.BG and child.BG.Icon then
            if child.BG.Icon.Image == targetImageId then
                return child
            end
        end
    end
    
    return nil
end

local function moveToFieldWithTween()
    local character = player.Character
    if not character then return false end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end
    
    local distance = (humanoidRootPart.Position - fieldPosition).Magnitude
    
    if distance > 10 then
        statusLabel.Text = "Moving to field..."
        
        local tweenInfo = TweenInfo.new(
            distance / MOVE_SPEED,
            Enum.EasingStyle.Linear
        )
        
        local tween = TweenService:Create(humanoidRootPart, tweenInfo, {Position = fieldPosition})
        tween:Play()
        
        wait(distance / MOVE_SPEED + 0.5)
    end
    
    return true
end

local function useItem(itemName)
    if itemName == "Glitter" then
        local GL = {["Name"] = "Glitter"}
        ReplicatedStorage.Events.PlayerActivesCommand:FireServer(GL)
        needGlitter = false
    elseif itemName == "Field Dice" then
        local FD = {["Name"] = "Field Dice"}
        ReplicatedStorage.Events.PlayerActivesCommand:FireServer(FD)
    end
end

local function checkAndUse()
    if not isActive then 
        return 
    end
    
    local currentTime = tick()
    if currentTime - lastCheckTime < CHECK_INTERVAL then
        return
    end
    lastCheckTime = currentTime
    
    debugLabel.Text = "Debug: Checking..."
    
    local iconTile = findBuffIconTile()
    if not iconTile then
        statusLabel.Text = "Buff not found"
        debugLabel.Text = "Debug: No buff"
        return
    end
    
    if not iconTile:FindFirstChild("BG") then
        statusLabel.Text = "BG not found"
        debugLabel.Text = "Debug: No BG"
        return
    end
    
    local bg = iconTile.BG
    
    local bar = bg:FindFirstChild("bar")
    if not bar then
        bar = bg:FindFirstChild("Bar")
    end
    
    if not bar then
        statusLabel.Text = "Bar not found"
        debugLabel.Text = "Debug: No bar"
        return
    end
    
    local barSize = bar.AbsoluteSize.Y
    barSizeLabel.Text = "Bar size: " .. tostring(math.floor(barSize * 10) / 10)
    
    if barSize > 3.2 then
        needGlitter = true
        statusLabel.Text = "Buff active"
        nextItemLabel.Text = "Next: Wait â‰¤3.2"
        debugLabel.Text = "Debug: Bar > 3.2"
        return
    end
    
    if barSize <= 3.2 then
        local itemToUse = nil
        
        if needGlitter then
            itemToUse = "Glitter"
        else
            itemToUse = "Field Dice"
        end
        
        if itemToUse then
            nextItemLabel.Text = "Next: " .. itemToUse
            
            if itemToUse == "Glitter" then
                if moveToFieldWithTween() then
                    statusLabel.Text = "Using " .. itemToUse
                    useItem(itemToUse)
                    wait(1)
                end
            else
                statusLabel.Text = "Using " .. itemToUse
                useItem(itemToUse)
                wait(1)
            end
            debugLabel.Text = "Debug: Used " .. itemToUse
        else
            statusLabel.Text = "Waiting"
            nextItemLabel.Text = "Next: Waiting"
            debugLabel.Text = "Debug: Waiting"
        end
    end
end

local function startDragging(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = Vector2.new(input.Position.X, input.Position.Y)
        frameStart = Vector2.new(frame.AbsolutePosition.X, frame.AbsolutePosition.Y)
    end
end

local function stopDragging(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
    end
end

local function updateDrag(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local currentPos = Vector2.new(input.Position.X, input.Position.Y)
        local delta = currentPos - dragStart
        
        local newX = math.clamp(frameStart.X + delta.X, 0, workspace.CurrentCamera.ViewportSize.X - frame.AbsoluteSize.X)
        local newY = math.clamp(frameStart.Y + delta.Y, 0, workspace.CurrentCamera.ViewportSize.Y - frame.AbsoluteSize.Y)
        
        frame.Position = UDim2.new(0, newX, 0, newY)
    end
end

titleBar.InputBegan:Connect(startDragging)
titleBar.InputEnded:Connect(stopDragging)
UserInputService.InputChanged:Connect(updateDrag)

closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

closeButton.TouchTap:Connect(function()
    screenGui:Destroy()
end)

toggleBtn.MouseButton1Click:Connect(function()
    isActive = not isActive
    
    if isActive then
        toggleBtn.Text = "Disable Auto Buff"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        statusLabel.Text = "Status: Active"
        statusLabel.TextColor3 = Color3.new(0.5, 1, 0.5)
        needGlitter = true
        debugLabel.Text = "Debug: Enabled"
    else
        toggleBtn.Text = "Enable Auto Buff"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        statusLabel.Text = "Status: Inactive"
        statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
        nextItemLabel.Text = "Next: -"
        needGlitter = true
        debugLabel.Text = "Debug: Disabled"
    end
end)

toggleBtn.TouchTap:Connect(function()
    isActive = not isActive
    
    if isActive then
        toggleBtn.Text = "Disable Auto Buff"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        statusLabel.Text = "Status: Active"
        statusLabel.TextColor3 = Color3.new(0.5, 1, 0.5)
        needGlitter = true
        debugLabel.Text = "Debug: Enabled"
    else
        toggleBtn.Text = "Enable Auto Buff"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        statusLabel.Text = "Status: Inactive"
        statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
        nextItemLabel.Text = "Next: -"
        needGlitter = true
        debugLabel.Text = "Debug: Disabled"
    end
end)

spawn(function()
    while wait(CHECK_INTERVAL) do
        if isActive then
            checkAndUse()
        end
    end
end)

print("Auto Field Buff loaded successfully!")
