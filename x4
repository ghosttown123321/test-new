local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local targetImageId = "rbxassetid://2908769190"
local fieldPosition = Vector3.new(-331.6, 68.0, -183.1)

local MOVE_SPEED = 12
local CHECK_INTERVAL = 1
local lastCheckTime = 0

local isActive = false
local needGlitter = true

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoBuffGUI"
screenGui.Parent = player.PlayerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 300, 0, 200)
frame.Position = UDim2.new(0.5, -150, 0, 10)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 2
frame.BorderColor3 = Color3.fromRGB(0, 170, 255)
frame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Text = "Auto Field Buff"
title.Size = UDim2.new(1, 0, 0, 30)
title.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.Parent = frame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Text = "Enable Auto Buff"
toggleBtn.Size = UDim2.new(0.8, 0, 0, 40)
toggleBtn.Position = UDim2.new(0.1, 0, 0.2, 0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.SourceSansBold
toggleBtn.TextSize = 16
toggleBtn.Parent = frame

local statusLabel = Instance.new("TextLabel")
statusLabel.Text = "Status: Inactive"
statusLabel.Size = UDim2.new(1, 0, 0, 30)
statusLabel.Position = UDim2.new(0, 0, 0.45, 0)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextSize = 16
statusLabel.Parent = frame

local nextItemLabel = Instance.new("TextLabel")
nextItemLabel.Text = "Next: -"
nextItemLabel.Size = UDim2.new(1, 0, 0, 30)
nextItemLabel.Position = UDim2.new(0, 0, 0.6, 0)
nextItemLabel.BackgroundTransparency = 1
nextItemLabel.TextColor3 = Color3.new(0.8, 0.8, 1)
nextItemLabel.Font = Enum.Font.SourceSans
nextItemLabel.TextSize = 16
nextItemLabel.Parent = frame

local barSizeLabel = Instance.new("TextLabel")
barSizeLabel.Text = "Bar size: -"
barSizeLabel.Size = UDim2.new(1, 0, 0, 30)
barSizeLabel.Position = UDim2.new(0, 0, 0.75, 0)
barSizeLabel.BackgroundTransparency = 1
barSizeLabel.TextColor3 = Color3.new(1, 1, 0.8)
barSizeLabel.Font = Enum.Font.SourceSans
barSizeLabel.TextSize = 16
barSizeLabel.Parent = frame

local function GetItemCount(itemName)
    local success, eggRowsFolder = pcall(function()
        return player.PlayerGui.ScreenGui.Menus.Children.Eggs.Content.EggRows
    end)
    
    if not success or not eggRowsFolder then
        return 0
    end
    
    for _, eggRow in ipairs(eggRowsFolder:GetChildren()) do
        if eggRow:FindFirstChild("TypeName") then
            local typeName = eggRow.TypeName.Text
            
            if typeName:lower():find(itemName:lower()) then
                local count = 0
                
                if eggRow:FindFirstChild("EggSlot") and eggRow.EggSlot:FindFirstChild("Count") then
                    local countText = eggRow.EggSlot.Count.Text
                    local extracted = countText:match("%d+")
                    if extracted then
                        count = tonumber(extracted)
                    end
                end
                
                if count == 0 and eggRow:FindFirstChild("ContentText") then
                    local contentText = eggRow.ContentText.Text
                    local extracted = contentText:match("%d+")
                    if extracted then
                        count = tonumber(extracted)
                    end
                end
                
                return count
            end
        end
    end
    
    return 0
end

local function findBuffIconTile()
    local success, tileGrid = pcall(function()
        return player.PlayerGui.ScreenGui.TileGrid
    end)
    
    if not success or not tileGrid then
        print("TileGrid not found")
        return nil
    end
    
    local child17 = tileGrid:GetChildren()[17]
    if child17 then
        local bg = child17:FindFirstChild("BG")
        if bg then
            local icon = bg:FindFirstChild("Icon")
            if icon and icon.Image == targetImageId then
                return child17
            end
        end
    end
    
    for _, child in ipairs(tileGrid:GetChildren()) do
        local bg = child:FindFirstChild("BG")
        if bg then
            local icon = bg:FindFirstChild("Icon")
            if icon and icon.Image == targetImageId then
                return child
            end
        end
    end
    
    return nil
end

local function moveToFieldWithTween()
    local character = player.Character
    if not character then return false end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end
    
    local distance = (humanoidRootPart.Position - fieldPosition).Magnitude
    
    if distance > 10 then
        statusLabel.Text = "Status: Moving to field..."
        
        local tweenInfo = TweenInfo.new(
            distance / MOVE_SPEED,
            Enum.EasingStyle.Linear,
            Enum.EasingDirection.Out,
            0,
            false,
            0
        )
        
        local goal = {}
        goal.Position = fieldPosition
        
        local tween = TweenService:Create(humanoidRootPart, tweenInfo, goal)
        tween:Play()
        
        local startTime = tick()
        while tween.PlaybackState == Enum.PlaybackState.Playing and tick() - startTime < 5 do
            wait(0.1)
        end
        
        tween:Cancel()
        
        wait(0.5)
    end
    
    return true
end

local function useItem(itemName)
    if itemName == "Glitter" then
        local GL = {["Name"] = "Glitter"}
        ReplicatedStorage.Events.PlayerActivesCommand:FireServer(GL)
        needGlitter = false
    elseif itemName == "Field Dice" then
        local FD = {["Name"] = "Field Dice"}
        ReplicatedStorage.Events.PlayerActivesCommand:FireServer(FD)
    end
end

local function checkAndUse()
    if not isActive then 
        return 
    end
    
    local currentTime = tick()
    if currentTime - lastCheckTime < CHECK_INTERVAL then
        return
    end
    lastCheckTime = currentTime
    
    local success1, iconTile = pcall(findBuffIconTile)
    if not success1 or not iconTile then
        statusLabel.Text = "Status: Buff not found"
        return
    end
    
    local success2, bar = pcall(function()
        return iconTile.BG.bar
    end)
    
    if not success2 or not bar then
        statusLabel.Text = "Status: Bar not found"
        return
    end
    
    local barSize = bar.AbsoluteSize.Y
    barSizeLabel.Text = string.format("Bar size: %.2f", barSize)
    
    local glitterCount = GetItemCount("Glitter")
    local diceCount = GetItemCount("Field Dice")
    
    if barSize > 3.2 then
        needGlitter = true
        statusLabel.Text = "Status: Buff active"
        nextItemLabel.Text = "Next: Waiting â‰¤3.2"
        return
    end
    
    if barSize <= 3.2 then
        local itemToUse = nil
        
        if needGlitter and glitterCount > 0 then
            itemToUse = "Glitter"
        elseif diceCount > 0 then
            itemToUse = "Field Dice"
        end
        
        if itemToUse then
            nextItemLabel.Text = "Next: " .. itemToUse
            
            if itemToUse == "Glitter" then
                if moveToFieldWithTween() then
                    statusLabel.Text = "Status: Using " .. itemToUse
                    useItem(itemToUse)
                    wait(1)
                end
            else
                statusLabel.Text = "Status: Using " .. itemToUse
                useItem(itemToUse)
                wait(1)
            end
        else
            statusLabel.Text = "Status: No items"
            nextItemLabel.Text = "Next: Waiting"
        end
    end
end

toggleBtn.MouseButton1Click:Connect(function()
    print("Button clicked!")
    isActive = not isActive
    
    if isActive then
        toggleBtn.Text = "Disable Auto Buff"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        statusLabel.Text = "Status: Active"
        statusLabel.TextColor3 = Color3.new(0.5, 1, 0.5)
        needGlitter = true
        print("Auto Buff enabled")
    else
        toggleBtn.Text = "Enable Auto Buff"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        statusLabel.Text = "Status: Inactive"
        statusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
        nextItemLabel.Text = "Next: -"
        needGlitter = true
        print("Auto Buff disabled")
    end
end)

RunService.Heartbeat:Connect(function()
    local success, err = pcall(function()
        checkAndUse()
    end)
    
    if not success then
        print("Error in checkAndUse: " .. tostring(err))
    end
end)

player.CharacterAdded:Connect(function()
    if not screenGui.Parent then
        screenGui.Parent = player.PlayerGui
    end
end)

print("Auto Field Buff script loaded successfully!")
print("Click the button to enable")
